<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Randomizer Ultimate</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --border-color: #333;
            --text-main: #eee;
            
            /* –¶–≤–µ—Ç–∞ —ç—Ç–∞–ø–æ–≤ */
            --c-event: #ff4444;
            --c-item: #33ccff;
            --c-game: #44ff44;

            /* –¶–≤–µ—Ç–∞ –∏–≥—Ä–æ–∫–æ–≤ */
            --p-manki: #ff0000;
            --p-shoker: #ff8800;
            --p-marenyuk: #ffff00;
            --p-sunekoi: #00ff00;
            --p-smail: #00ffff;
            --p-malekith: #0000ff;
            --p-cenoval: #8800ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- 1. –í–´–ë–û–† –ò–ì–†–û–ö–ê --- */
        .player-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .btn-player {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #aaa;
            padding: 10px 20px;
            cursor: pointer;
            position: relative;
            padding-left: 30px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ */
            font-weight: bold;
            transition: 0.2s;
        }

        /* –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ —á–µ—Ä–µ–∑ CSS */
        .btn-player::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0; 
            height: 0; 
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid var(--p-color, #fff);
        }

        .btn-player:hover, .btn-player.active {
            background: #333;
            color: #fff;
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        /* --- –ì–õ–ê–í–ù–ê–Ø –°–ï–¢–ö–ê --- */
        .main-grid {
            display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ */
            grid-template-columns: 250px 400px 250px;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–ü–†–ï–°–ï–¢–´) --- */
        .preset-btn {
            background: #222;
            border: 1px solid #555;
            color: #fff;
            padding: 10px;
            cursor: pointer;
            width: 100%;
        }
        .preset-btn:hover { background: #333; }

        /* --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ (–ò–ì–†–ê) --- */
        .center-panel {
            align-items: center;
        }

        /* –í—ã–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ */
        select.route-select {
            width: 100%;
            padding: 10px;
            background: #000;
            color: #fff;
            border: 1px solid #555;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* –¢–∞–±—ã —ç—Ç–∞–ø–æ–≤ */
        .stage-tabs {
            display: flex;
            width: 100%;
            margin-bottom: 15px;
            background: #000;
        }
        .stage-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
            color: #444;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: 0.3s;
        }
        /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
        .stage-tab[data-stage="event"].active { color: var(--c-event); border-color: var(--c-event); background: rgba(255, 68, 68, 0.1); }
        .stage-tab[data-stage="item"].active { color: var(--c-item); border-color: var(--c-item); background: rgba(51, 204, 255, 0.1); }
        .stage-tab[data-stage="game"].active { color: var(--c-game); border-color: var(--c-game); background: rgba(68, 255, 68, 0.1); }

        /* –ö–æ–ª–µ—Å–æ */
        .wheel-container {
            position: relative;
            margin: 10px 0;
        }
        canvas {
            border-radius: 50%;
            border: 5px solid #333;
            background: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
        }
        .pointer {
            position: absolute;
            top: -15px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #fff;
            z-index: 10;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ö—Ä—É—Ç–∏—Ç—å */
        #spinBtn {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            text-transform: uppercase;
            font-weight: bold;
            border: none;
            background: #222;
            color: #555;
            cursor: not-allowed;
            margin-top: 20px;
        }
        #spinBtn.ready { cursor: pointer; color: #000; }

        /* --- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–õ–û–ì –ò –õ–ï–ì–ï–ù–î–ê) --- */
        .legend-list {
            list-style: none;
            padding: 0;
            font-size: 0.85rem;
            color: #aaa;
        }
        .legend-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #222;
            padding: 4px 0;
        }

        .log-container {
            flex-grow: 1;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            overflow-y: auto;
            max-height: 200px;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-stage { font-weight: bold; }
        
        .clear-log-btn {
            background: #330000;
            color: #ff4444;
            border: 1px solid #555;
            padding: 5px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–†–ï–°–ï–¢–û–í --- */
        #presetModal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            border: 2px solid #fff;
            padding: 20px;
            z-index: 1000;
            width: 300px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }
        .modal-row { margin-bottom: 15px; }
        .modal-row label { display: block; margin-bottom: 5px; color: #aaa; }
        .modal-row select { width: 100%; padding: 8px; background: #000; color: #fff; border: 1px solid #444; }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .panel { order: 2; }
            .center-panel { order: 1; }
        }
    </style>
</head>
<body>

    <div class="player-bar">
        <button class="btn-player" style="--p-color: var(--p-manki)" onclick="selectPlayer('Manki', this)">Manki</button>
        <button class="btn-player" style="--p-color: var(--p-shoker)" onclick="selectPlayer('Shoker', this)">Shoker</button>
        <button class="btn-player" style="--p-color: var(--p-marenyuk)" onclick="selectPlayer('Marenyuk', this)">Marenyuk</button>
        <button class="btn-player" style="--p-color: var(--p-sunekoi)" onclick="selectPlayer('Sunekoi', this)">Sunekoi</button>
        <button class="btn-player" style="--p-color: var(--p-smail)" onclick="selectPlayer('Smailgames', this)">Smailgames</button>
        <button class="btn-player" style="--p-color: var(--p-malekith)" onclick="selectPlayer('Malekith', this)">Malekith</button>
        <button class="btn-player" style="--p-color: var(--p-cenoval)" onclick="selectPlayer('Cenoval', this)">Cenoval</button>
    </div>

    <div class="main-grid" id="mainGrid">
        
        <div class="panel">
            <h3 style="margin: 0 0 10px 0;">–ù–ê–°–¢–†–û–ô–ö–ò</h3>
            <button class="preset-btn" onclick="openPresetModal()">üõ† –í–´–ë–û–† –ü–†–ï–°–ï–¢–û–í</button>
            <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                –¢–µ–∫—É—â–∏–µ –ø—Ä–µ—Å–µ—Ç—ã:<br>
                E: <span id="lblEvent">Default</span><br>
                I: <span id="lblItem">Default</span><br>
                G: <span id="lblGame">Default</span>
            </div>
        </div>

        <div class="panel center-panel">
            <select class="route-select" id="routeSelect" onchange="handleRouteSelect()">
                <option value="" disabled selected>-- –í–´–ë–ï–†–ò–¢–ï –ú–ê–†–®–†–£–¢ --</option>
                <optgroup label="–ó–ï–õ–ï–ù–ê–Ø –í–ï–¢–ö–ê (üü¢)" style="color: #44ff44;">
                    <option value="Green_A">–¢–æ—á–∫–∞ A</option>
                    <option value="Green_B">–¢–æ—á–∫–∞ B</option>
                    <option value="Green_V">–¢–æ—á–∫–∞ V</option>
                    <option value="Green_G">–¢–æ—á–∫–∞ G</option>
                    <option value="Green_D">–¢–æ—á–∫–∞ D</option>
                </optgroup>
                <optgroup label="–ö–†–ê–°–ù–ê–Ø –í–ï–¢–ö–ê (üî¥)" style="color: #ff4444;">
                    <option value="Red_1">–¢–æ—á–∫–∞ 1</option>
                    <option value="Red_2">–¢–æ—á–∫–∞ 2</option>
                    <option value="Red_3">–¢–æ—á–∫–∞ 3</option>
                    <option value="Red_4">–¢–æ—á–∫–∞ 4</option>
                    <option value="Red_5">–¢–æ—á–∫–∞ 5</option>
                    <option value="Red_6">–¢–æ—á–∫–∞ 6</option>
                    <option value="Red_7">–¢–æ—á–∫–∞ 7</option>
                    <option value="Red_8">–¢–æ—á–∫–∞ 8</option>
                    <option value="Red_9">–¢–æ—á–∫–∞ 9</option>
                </optgroup>
                <optgroup label="–°–ò–ù–Ø–Ø –í–ï–¢–ö–ê (üîµ)" style="color: #4488ff;">
                    <option value="Blue_X">–¢–æ—á–∫–∞ X</option>
                    <option value="Blue_Y">–¢–æ—á–∫–∞ Y</option>
                </optgroup>
            </select>

            <div class="stage-tabs">
                <div class="stage-tab" id="tab_event" data-stage="event" onclick="manualStageSelect('event')">1. –ò–í–ï–ù–¢</div>
                <div class="stage-tab" id="tab_item" data-stage="item" onclick="manualStageSelect('item')">2. –ü–†–ï–î–ú–ï–¢</div>
                <div class="stage-tab" id="tab_game" data-stage="game" onclick="manualStageSelect('game')">3. –ò–ì–†–ê</div>
            </div>

            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="350" height="350"></canvas>
            </div>
            
            <div id="statusMessage" style="min-height: 1.2em; color: #aaa;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

            <button id="spinBtn" onclick="spinWheel()" disabled>–í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£</button>
        </div>

        <div class="panel">
            <h3 style="margin: 0 0 10px 0;">–®–ê–ù–°–´</h3>
            <ul class="legend-list" id="legendList">
                </ul>

            <h3 style="margin: 20px 0 10px 0;">–õ–û–ì</h3>
            <div class="log-container" id="logContainer">
                </div>
            <button class="clear-log-btn" onclick="clearLog()">–û–ß–ò–°–¢–ò–¢–¨ –õ–û–ì</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div id="presetModal">
        <h3>–í–´–ë–û–† –ü–†–ï–°–ï–¢–û–í</h3>
        
        <div class="modal-row">
            <label>–ò–≤–µ–Ω—Ç—ã:</label>
            <select id="selPresetEvent">
                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="hardcore">–•–∞—Ä–¥–∫–æ—Ä (+–°–ª–æ–∂–Ω–æ—Å—Ç—å)</option>
                <option value="lucky">–£–¥–∞—á–∞ (+–õ—É—Ç)</option>
            </select>
        </div>
        <div class="modal-row">
            <label>–ü—Ä–µ–¥–º–µ—Ç—ã:</label>
            <select id="selPresetItem">
                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="rich">–ë–æ–≥–∞—Ç—ã–π –ª—É—Ç</option>
                <option value="poor">–ë–µ–¥–Ω—ã–π –ª—É—Ç</option>
            </select>
        </div>
        <div class="modal-row">
            <label>–ò–≥—Ä—ã:</label>
            <select id="selPresetGame">
                <option value="default">–ú–∏–∫—Å (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                <option value="aaa">–¢–æ–ª—å–∫–æ AAA</option>
                <option value="indie">–¢–æ–ª—å–∫–æ Indie</option>
                <option value="retro">Retro Pack</option>
            </select>
        </div>

        <button class="preset-btn" style="background: var(--c-game); color: #000; font-weight: bold;" onclick="applyPresets()">–ü–†–ò–ú–ï–ù–ò–¢–¨</button>
        <button class="preset-btn" style="margin-top: 10px; border-color: red; color: red;" onclick="closePresetModal()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        const SCRIPT_URL = '/api/submit'; // Vercel rewrite link

        // –î–ê–ù–ù–´–ï (–ü—É–Ω–∫—Ç 7 –õ–æ–≥–∏–∫–∏: –û–±—ä–µ–∫—Ç—ã —Å –∏–º–µ–Ω–µ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º)
        const DATA_POOL = {
            events: {
                'default': [
                    { name: '–ü—É—Å—Ç–æ', desc: '–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ' },
                    { name: '–í—Ä–∞–≥', desc: '–ë–æ–π —Å –æ–±—ã—á–Ω—ã–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º' },
                    { name: '–õ–æ–≤—É—à–∫–∞', desc: '–ü–æ—Ç–µ—Ä—è -1 –•–ü –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞' },
                    { name: '–¢–æ—Ä–≥–æ–≤–µ—Ü', desc: '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–º–µ–Ω–∞' }
                ],
                'hardcore': [
                    { name: '–ë–û–°–°', desc: '–ë–æ–π —Å –±–æ—Å—Å–æ–º –ª–æ–∫–∞—Ü–∏–∏' },
                    { name: '–ó–∞—Å–∞–¥–∞', desc: '–ë–æ–π —Å 3 –≤—Ä–∞–≥–∞–º–∏ —Å—Ä–∞–∑—É' },
                    { name: '–ü—Ä–æ–∫–ª—è—Ç–∏–µ', desc: '–î–µ–±–∞—Ñ—Ñ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å' }
                ],
                'lucky': [
                    { name: '–°—É–Ω–¥—É–∫', desc: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç' },
                    { name: '–§–æ–Ω—Ç–∞–Ω', desc: '–ü–æ–ª–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ' },
                    { name: '–•–∞–ª—è–≤–∞', desc: '–ü—Ä–æ–ø—É—Å–∫ –±–æ—è' }
                ]
            },
            items: {
                'default': [
                    { name: '–ê–ø—Ç–µ—á–∫–∞', desc: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ' },
                    { name: '–ü–∞—Ç—Ä–æ–Ω—ã', desc: '–ë–æ–µ–∑–∞–ø–∞—Å' },
                    { name: '–ï–¥–∞', desc: '–ü—Ä–æ–≤–∏–∑–∏—è –Ω–∞ –¥–µ–Ω—å' }
                ],
                'rich': [
                    { name: '–ó–æ–ª–æ—Ç–æ–π –∫–ª—é—á', desc: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–¥–∫–∏–µ –¥–≤–µ—Ä–∏' },
                    { name: '–ë—Ä–æ–Ω—è', desc: '–ó–∞—â–∏—Ç–∞ +50' },
                    { name: '–í–∏–Ω—Ç–æ–≤–∫–∞', desc: '–ú–æ—â–Ω–æ–µ –æ—Ä—É–∂–∏–µ' }
                ],
                'poor': [
                    { name: '–ì–Ω–∏–ª—å', desc: '–ú—É—Å–æ—Ä' },
                    { name: '–†–∂–∞–≤—ã–π –Ω–æ–∂', desc: '–°–ª–∞–±–æ–µ –æ—Ä—É–∂–∏–µ' }
                ]
            },
            games: {
                'default': [
                    { name: 'Hades', desc: 'Roguelike Action' },
                    { name: 'Doom', desc: 'FPS Shooter' },
                    { name: 'Celeste', desc: 'Hardcore Platformer' },
                    { name: 'Stardew', desc: 'Farming Sim' }
                ],
                'aaa': [
                    { name: 'Elden Ring', desc: 'Souls-like Open World' },
                    { name: 'Cyberpunk', desc: 'RPG Action' },
                    { name: 'RDR 2', desc: 'Western Action' }
                ],
                'indie': [
                    { name: 'Hollow Knight', desc: 'Metroidvania' },
                    { name: 'Cuphead', desc: 'Boss Rush' },
                    { name: 'Limbo', desc: 'Puzzle Platformer' }
                ],
                'retro': [
                    { name: 'Mario', desc: 'NES Classic' },
                    { name: 'Sonic', desc: 'Sega Classic' },
                    { name: 'Tetris', desc: 'Puzzle' }
                ]
            }
        };

        const STAGE_CONFIG = {
            'event': { color: '#ff4444', label: '–ö–†–£–¢–ò–¢–¨ –ò–í–ï–ù–¢' },
            'item':  { color: '#33ccff', label: '–ö–†–£–¢–ò–¢–¨ –ü–†–ï–î–ú–ï–¢' },
            'game':  { color: '#44ff44', label: '–ö–†–£–¢–ò–¢–¨ –ò–ì–†–£' }
        };

        // === STATE ===
        let currentPlayer = null;
        let currentRoute = null;
        let currentStage = null; 
        let isAutoMode = true; // –õ–æ–≥–∏–∫–∞ –ø.4
        let isSpinning = false;
        
        let activePresets = { event: 'default', item: 'default', game: 'default' };
        let currentSegments = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {name, desc}
        let currentAngle = 0;

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const statusMsg = document.getElementById('statusMessage');
        const legendList = document.getElementById('legendList');
        const logContainer = document.getElementById('logContainer');

        // --- 1. –í–´–ë–û–† –ò–ì–†–û–ö–ê ---
        function selectPlayer(name, btn) {
            currentPlayer = name;
            document.querySelectorAll('.btn-player').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('mainGrid').style.display = 'grid';
            resetInterface(); 
        }

        // --- 2. –í–´–ë–û–† –ú–ê–†–®–†–£–¢–ê ---
        function handleRouteSelect() {
            currentRoute = document.getElementById('routeSelect').value;
            isAutoMode = true; // –õ–æ–≥–∏–∫–∞ –ø.4: –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ
            setStage('event'); // –õ–æ–≥–∏–∫–∞ –ø.2: –°—Ç–∞—Ä—Ç —Å –ò–≤–µ–Ω—Ç–∞
        }

        // --- 4. –†–£–ß–ù–û–ô –í–´–ë–û–† –≠–¢–ê–ü–ê ---
        function manualStageSelect(stage) {
            if (!currentRoute) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!");
                return;
            }
            isAutoMode = false; // –õ–æ–≥–∏–∫–∞ –ø.4: –í—ã–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ
            setStage(stage);
        }

        // --- –£–°–¢–ê–ù–û–í–ö–ê –≠–¢–ê–ü–ê –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
        function setStage(stageName) {
            currentStage = stageName;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–õ–æ–≥–∏–∫–∞ –ø.5 + –í–∏–∑—É–∞–ª –ø.8)
            // –ë–µ—Ä–µ–º –∫–ª—é—á –ø—Ä–µ—Å–µ—Ç–∞ –∏–∑ activePresets, –∑–∞—Ç–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ DATA_POOL
            const presetKey = activePresets[stageName];
            const pool = DATA_POOL[stageName + 's']; // events, items, games
            currentSegments = pool[presetKey] || pool['default'];

            // UI –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab_${stageName}`).classList.add('active');

            const config = STAGE_CONFIG[stageName];
            spinBtn.disabled = false;
            spinBtn.innerText = config.label;
            spinBtn.style.backgroundColor = config.color;
            spinBtn.style.color = "#000";
            spinBtn.classList.add('ready');
            
            // –¶–≤–µ—Ç –∫–æ–ª–µ—Å–∞ (–í–∏–∑—É–∞–ª –ø.6)
            canvas.style.borderColor = config.color;

            drawWheel();
            updateLegend();
        }

        // --- –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´ ---
        function drawWheel() {
            const len = currentSegments.length;
            if (len === 0) {
                // –ü—É—Å—Ç–æ–µ –∫–æ–ª–µ—Å–æ
                ctx.clearRect(0,0,350,350);
                ctx.beginPath();
                ctx.arc(175,175,160,0,Math.PI*2);
                ctx.strokeStyle="#333"; ctx.stroke();
                return;
            }

            const step = (Math.PI * 2) / len;
            const cx = 175, cy = 175;

            ctx.clearRect(0, 0, 350, 350);

            for(let i=0; i<len; i++) {
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, 168, currentAngle + i*step, currentAngle + (i+1)*step);
                ctx.fillStyle = (i % 2 === 0) ? '#1a1a1a' : '#2a2a2a';
                ctx.fill();
                ctx.strokeStyle = STAGE_CONFIG[currentStage].color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // –¢–µ–∫—Å—Ç
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(currentAngle + i*step + step/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 13px Segoe UI";
                let text = currentSegments[i].name;
                if(text.length > 15) text = text.substring(0,14) + '.';
                ctx.fillText(text, 150, 5);
                ctx.restore();
            }
        }

        function spinWheel() {
            if (isSpinning || !currentStage) return;
            isSpinning = true;
            spinBtn.disabled = true;
            statusMsg.innerText = "–í—Ä–∞—â–µ–Ω–∏–µ...";

            let duration = 2500 + Math.random() * 1000;
            let start = null;
            let velocity = 0.5 + Math.random() * 0.3;

            function animate(time) {
                if(!start) start = time;
                let progress = time - start;

                if (progress < duration) {
                    // Easing func
                    velocity *= 0.99;
                    currentAngle += velocity;
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    finishSpin();
                }
            }
            requestAnimationFrame(animate);
        }

        function finishSpin() {
            const len = currentSegments.length;
            const step = (Math.PI * 2) / len;
            const normAngle = currentAngle % (Math.PI * 2);
            let index = Math.floor((Math.PI * 2 - normAngle) / step);
            // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è -90 –≥—Ä–∞–¥—É—Å–æ–≤ (—Å—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É)
            index = (index + len - Math.floor(len/4)) % len;

            const resultObj = currentSegments[index];
            const resultName = resultObj.name;
            const resultDesc = resultObj.desc;

            // –õ–æ–≥ (–í–∏–∑—É–∞–ª –ø.7)
            const chance = (100 / len).toFixed(1) + '%';
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-stage" style="color:${STAGE_CONFIG[currentStage].color}">${currentStage.toUpperCase()}</span> | ${resultName} | ${chance}`;
            logContainer.prepend(logEntry);

            statusMsg.innerText = `–í—ã–ø–∞–ª–æ: ${resultName}`;
            statusMsg.style.color = STAGE_CONFIG[currentStage].color;

            sendData(resultName, resultDesc);
        }

        // --- –û–¢–ü–†–ê–í–ö–ê (–õ–æ–≥–∏–∫–∞ –ø.10) ---
        function sendData(val, desc) {
            const payload = {
                player: currentPlayer,
                point: currentRoute,
                description: desc
            };

            if (currentStage === 'event') payload.event = val;
            if (currentStage === 'item') payload.item = val;
            if (currentStage === 'game') payload.game = val;

            statusMsg.innerText += " [–û—Ç–ø—Ä–∞–≤–∫–∞...]";

            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.innerText = "–†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–ü–ò–°–ê–ù!";
                    handlePostSubmit();
                }
            })
            .catch(err => {
                statusMsg.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!";
                statusMsg.style.color = "red";
                console.error(err);
            });
        }

        // --- –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –ò –°–ë–†–û–° (–õ–æ–≥–∏–∫–∞ –ø.12, 13) ---
        function handlePostSubmit() {
            if (isAutoMode) {
                setTimeout(() => {
                    if (currentStage === 'event') setStage('item');
                    else if (currentStage === 'item') setStage('game');
                    else if (currentStage === 'game') {
                        // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞
                        resetInterface(false); // false = –Ω–µ –æ—á–∏—â–∞—Ç—å –ª–æ–≥
                    }
                }, 1000);
            } else {
                // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º - —Å–±—Ä–æ—Å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ
                setTimeout(() => {
                    resetInterface(false);
                }, 1000);
            }
        }

        function resetInterface(fullClear = true) {
            currentStage = null;
            currentSegments = [];
            
            // –°–±—Ä–æ—Å –∫–æ–ª–µ—Å–∞
            ctx.clearRect(0,0,350,350);
            ctx.beginPath();
            ctx.arc(175,175,160,0,Math.PI*2);
            ctx.strokeStyle="#333"; ctx.stroke();

            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏
            spinBtn.disabled = true;
            spinBtn.innerText = "–í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£";
            spinBtn.style.background = "#222";
            spinBtn.classList.remove('ready');

            // –°–±—Ä–æ—Å —Ç–∞–±–æ–≤
            document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));

            // –°–±—Ä–æ—Å —Å–µ–ª–µ–∫—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (—á—Ç–æ–±—ã –∑–∞—Å—Ç–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ)
            document.getElementById('routeSelect').value = "";
            currentRoute = null;

            statusMsg.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞...";
            statusMsg.style.color = "#aaa";
            
            // –õ–û–ì –ù–ï –û–ß–ò–©–ê–ï–¢–°–Ø –ó–î–ï–°–¨ (–õ–æ–≥–∏–∫–∞ –ø.12)
        }

        function updateLegend() {
            legendList.innerHTML = '';
            const total = currentSegments.length;
            if (total === 0) return;
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —à–∞–Ω—Å–æ–≤
            const counts = {};
            currentSegments.forEach(o => { counts[o.name] = (counts[o.name] || 0) + 1; });

            Object.keys(counts).forEach(key => {
                const li = document.createElement('li');
                li.className = 'legend-item';
                const percent = ((counts[key] / total) * 100).toFixed(1);
                li.innerHTML = `<span>${key}</span> <span>${percent}%</span>`;
                legendList.appendChild(li);
            });
        }

        function clearLog() {
            logContainer.innerHTML = '';
        }

        // --- –ú–û–î–ê–õ–ö–ê –ü–†–ï–°–ï–¢–û–í ---
        const modal = document.getElementById('presetModal');
        const overlay = document.getElementById('modalOverlay');

        function openPresetModal() {
            modal.style.display = 'block';
            overlay.style.display = 'block';
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–º–∏
            document.getElementById('selPresetEvent').value = activePresets.event;
            document.getElementById('selPresetItem').value = activePresets.item;
            document.getElementById('selPresetGame').value = activePresets.game;
        }

        function closePresetModal() {
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        function applyPresets() {
            activePresets.event = document.getElementById('selPresetEvent').value;
            activePresets.item = document.getElementById('selPresetItem').value;
            activePresets.game = document.getElementById('selPresetGame').value;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–∞–Ω–µ–ª–∏
            document.getElementById('lblEvent').innerText = activePresets.event;
            document.getElementById('lblItem').innerText = activePresets.item;
            document.getElementById('lblGame').innerText = activePresets.game;

            // –ï—Å–ª–∏ –∫–æ–ª–µ—Å–æ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç
            if (currentStage) {
                setStage(currentStage);
            }
            closePresetModal();
        }

    </script>
</body>
</html>
