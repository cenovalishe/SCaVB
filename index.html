<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival System // NIGHT SHIFT</title>
    <style>
        /* --- FNAF / INDUSTRIAL THEME --- */
        :root {
            --bg-color: #050300;
            --panel-bg: #110d00;
            --main-orange: #ff8800; /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π */
            --dim-orange: #663300;
            --text-color: #ffaa44;
            --alert-red: #ff3333;
            
            /* –¶–≤–µ—Ç–∞ —ç—Ç–∞–ø–æ–≤ */
            --c-event: #ff4444;
            --c-item: #33ccff;
            --c-game: #44ff44;

            --scanline: rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Impact', 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            text-transform: uppercase;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞—Ä–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∞ */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                var(--scanline),
                var(--scanline) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
        }

        h1 {
            text-shadow: 2px 2px 0px var(--dim-orange);
            letter-spacing: 5px;
            margin-bottom: 30px;
            animation: flicker 4s infinite;
        }

        /* --- 1. –í–´–ë–û–† –ò–ì–†–û–ö–ê --- */
        .player-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            z-index: 10;
        }

        .btn-player {
            background: #000;
            border: 2px solid #332200;
            color: #664400;
            padding: 10px 20px;
            padding-left: 35px;
            cursor: pointer;
            position: relative;
            font-family: inherit;
            font-size: 1rem;
            transition: 0.2s;
        }

        .btn-player::before {
            content: '';
            position: absolute;
            left: 10px; top: 50%;
            transform: translateY(-50%);
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid var(--p-color, #555);
        }

        .btn-player:hover, .btn-player.active {
            border-color: var(--main-orange);
            color: var(--main-orange);
            background: #1a1000;
            box-shadow: 0 0 15px var(--dim-orange);
        }

        /* --- –ì–õ–ê–í–ù–ê–Ø –°–ï–¢–ö–ê --- */
        .main-grid {
            display: none; /* –°–∫—Ä—ã—Ç–æ –¥–æ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ */
            grid-template-columns: 250px 450px 300px;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            position: relative;
            z-index: 1;
        }

        .panel {
            background: var(--panel-bg);
            border: 2px solid #332200;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: inset 0 0 20px #000;
        }

        /* --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ --- */
        select {
            background: #000;
            color: var(--main-orange);
            border: 1px solid var(--main-orange);
            padding: 10px;
            font-family: inherit;
            font-size: 1.1rem;
            width: 100%;
        }

        .enemy-warning {
            min-height: 24px;
            color: var(--alert-red);
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 5px red;
            letter-spacing: 2px;
        }

        /* –¢–∞–±—ã —ç—Ç–∞–ø–æ–≤ */
        .stage-indicators {
            display: flex;
            width: 100%;
            background: #000;
            border: 1px solid #332200;
        }
        .stage-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
            color: #443322;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.3s;
        }
        .stage-tab.active {
            color: #fff;
            background: #221100;
        }

        /* –ö–æ–ª–µ—Å–æ */
        .wheel-container {
            position: relative;
            margin: 10px auto;
            width: 350px; height: 350px;
        }
        canvas {
            border-radius: 50%;
            border: 6px solid #221100;
            background: #000;
            box-shadow: 0 0 20px rgba(255, 136, 0, 0.1);
        }
        .pointer {
            position: absolute;
            top: -15px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #fff;
            filter: drop-shadow(0 0 5px #fff);
            z-index: 10;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ö—Ä—É—Ç–∏—Ç—å */
        .big-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.5rem;
            font-family: inherit;
            text-transform: uppercase;
            font-weight: bold;
            background: #000;
            border: 2px solid var(--main-orange);
            color: var(--main-orange);
            cursor: pointer;
            transition: 0.1s;
            letter-spacing: 3px;
        }
        .big-btn:hover:not(:disabled) {
            background: var(--main-orange);
            color: #000;
            box-shadow: 0 0 20px var(--main-orange);
        }
        .big-btn:disabled {
            border-color: #444;
            color: #444;
            cursor: not-allowed;
            background: #0a0a0a;
        }

        /* –ü–∞–Ω–µ–ª—å –ò–≥—Ä—ã (Complete/Reroll/Drop) */
        .game-actions {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            gap: 10px;
        }
        .action-row { display: flex; gap: 10px; }
        
        .btn-complete { border-color: #00ff00; color: #00ff00; flex: 1; }
        .btn-complete:hover { background: #00ff00; color: #000; box-shadow: 0 0 15px #00ff00; }
        
        .btn-reroll { border-color: #ffff00; color: #ffff00; flex: 1; font-size: 1rem; padding: 15px;}
        .btn-reroll:hover { background: #ffff00; color: #000; }
        
        .btn-drop { border-color: #ff0000; color: #ff0000; flex: 1; font-size: 1rem; padding: 15px;}
        .btn-drop:hover { background: #ff0000; color: #000; }

        /* --- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–õ–û–ì) --- */
        .log-container {
            flex: 1;
            background: #000;
            border: 1px solid var(--dim-orange);
            padding: 10px;
            overflow-y: auto;
            max-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
        .log-entry { 
            margin-bottom: 8px; 
            border-bottom: 1px dashed #332200; 
            padding-bottom: 4px; 
        }
        .log-game { color: var(--c-game); font-weight: bold; border-left: 2px solid var(--c-game); padding-left: 5px; }

        /* –õ–µ–≥–µ–Ω–¥–∞ —à–∞–Ω—Å–æ–≤ */
        .legend-list { list-style: none; padding: 0; margin: 0; font-size: 0.8rem; }
        .legend-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #222; }

        /* --- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–ü–†–ï–°–ï–¢–´) --- */
        .preset-btn {
            background: #111; border: 1px solid #444; color: #888;
            width: 100%; padding: 10px; cursor: pointer; text-align: left;
        }
        .preset-btn:hover { border-color: var(--main-orange); color: #fff; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; }
        .modal {
            position: absolute; top:50%; left:50%; transform:translate(-50%, -50%);
            background: #111; border: 2px solid var(--main-orange);
            padding: 20px; width: 300px; box-shadow: 0 0 30px var(--dim-orange);
        }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        #statusMessage { margin-top: 10px; text-align: center; color: #888; min-height: 1.2em;}

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes flicker {
            0% { opacity: 1; } 50% { opacity: 0.8; } 52% { opacity: 0.4; } 54% { opacity: 1; } 100% { opacity: 1; }
        }

        @media (max-width: 1000px) {
            .main-grid { grid-template-columns: 1fr; }
            .panel { order: 2; }
            .center-panel { order: 1; }
        }
    </style>
</head>
<body>

    <h1>SYSTEM_RANDOMIZER v3.0</h1>

    <div class="player-bar">
        <button class="btn-player" style="--p-color: #ff0000" onclick="selectPlayer('Manki', this)">Manki</button>
        <button class="btn-player" style="--p-color: #ff8800" onclick="selectPlayer('Shoker', this)">Shoker</button>
        <button class="btn-player" style="--p-color: #ffff00" onclick="selectPlayer('Marenyuk', this)">Marenyuk</button>
        <button class="btn-player" style="--p-color: #00ff00" onclick="selectPlayer('Sunekoi', this)">Sunekoi</button>
        <button class="btn-player" style="--p-color: #00ffff" onclick="selectPlayer('Smailgames', this)">Smailgames</button>
        <button class="btn-player" style="--p-color: #0000ff" onclick="selectPlayer('Malekith', this)">Malekith</button>
        <button class="btn-player" style="--p-color: #8800ff" onclick="selectPlayer('Cenoval', this)">Cenoval</button>
    </div>

    <div class="main-grid" id="mainGrid">
        
        <div class="panel">
            <h3>‚öô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø</h3>
            <button class="preset-btn" onclick="openPresetModal()">üõ† –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ï–°–ï–¢–û–í</button>
            <div style="font-size: 0.75rem; color: #666;">
                EVENT: <span id="dispEvent" style="color:#fff">Default</span><br>
                ITEM: <span id="dispItem" style="color:#fff">Default</span><br>
                GAME: <span id="dispGame" style="color:#fff">Default</span>
            </div>
            <hr style="border-color: #333; width: 100%;">
            <h3>üìä –®–ê–ù–°–´ (DROP %)</h3>
            <ul class="legend-list" id="legendList"></ul>
        </div>

        <div class="panel center-panel">
            
            <select id="routeSelect" onchange="handleRouteSelect()">
                <option value="" disabled selected>-- –í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£ –ú–ê–†–®–†–£–¢–ê --</option>
                <optgroup label="üü¢ –ó–ï–õ–ï–ù–ê–Ø –ó–û–ù–ê">
                    <option value="Green_A">–°–µ–∫—Ç–æ—Ä A</option>
                    <option value="Green_B">–°–µ–∫—Ç–æ—Ä B</option>
                    <option value="Green_C">–°–µ–∫—Ç–æ—Ä C</option>
                </optgroup>
                <optgroup label="üî¥ –ö–†–ê–°–ù–ê–Ø –ó–û–ù–ê (–û–ü–ê–°–ù–û–°–¢–¨)">
                    <option value="Red_1">–°–µ–∫—Ç–æ—Ä 1</option>
                    <option value="Red_2">–°–µ–∫—Ç–æ—Ä 2</option>
                    <option value="Red_9">–°–µ–∫—Ç–æ—Ä 9 (–ì–ù–ï–ó–î–û)</option> </optgroup>
                <optgroup label="üîµ –°–ò–ù–Ø–Ø –ó–û–ù–ê">
                    <option value="Blue_X">–°–µ–∫—Ç–æ—Ä X</option>
                </optgroup>
            </select>

            <div class="enemy-warning" id="enemyWarning"></div>

            <div class="stage-indicators">
                <div class="stage-tab" id="tab_event" onclick="manualSetStage('event')">1. –ò–í–ï–ù–¢</div>
                <div class="stage-tab" id="tab_item" onclick="manualSetStage('item')">2. –ü–†–ï–î–ú–ï–¢</div>
                <div class="stage-tab" id="tab_game" onclick="manualSetStage('game')">3. –ò–ì–†–ê</div>
            </div>

            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="350" height="350"></canvas>
            </div>

            <div id="statusMessage">–û–ñ–ò–î–ê–ù–ò–ï...</div>

            <button class="big-btn" id="spinBtn" onclick="spinWheel()" disabled>–í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£</button>

            <div class="game-actions" id="gameActions">
                <button class="big-btn btn-complete" onclick="handleGameAction('COMPLETE')">‚úÖ –ü–†–û–ô–î–ï–ù–û</button>
                <div class="action-row">
                    <button class="big-btn btn-reroll" onclick="handleGameAction('REROLL')">üîÑ –†–ï–†–û–õ–õ</button>
                    <button class="big-btn btn-drop" onclick="handleGameAction('DROP')">‚ùå –î–†–û–ü</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>üìù –°–ò–°–¢–ï–ú–ù–´–ô –õ–û–ì</h3>
            <div class="log-container" id="logContainer">
                </div>
            <button class="preset-btn" style="text-align: center; color: var(--alert-red); border-color: var(--alert-red);" onclick="clearLog()">–û–ß–ò–°–¢–ò–¢–¨ –õ–û–ì</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3 style="margin-top:0;">–ü–†–ï–°–ï–¢–´</h3>
            <label>–ò–≤–µ–Ω—Ç—ã:</label>
            <select id="setEvent" style="margin-bottom:10px;">
                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="hardcore">–•–∞—Ä–¥–∫–æ—Ä</option>
            </select>
            <label>–ü—Ä–µ–¥–º–µ—Ç—ã:</label>
            <select id="setItem" style="margin-bottom:10px;">
                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                <option value="rich">–ë–æ–≥–∞—Ç—ã–π –ª—É—Ç</option>
            </select>
            <label>–ò–≥—Ä—ã:</label>
            <select id="setGame" style="margin-bottom:20px;">
                <option value="default">–ú–∏–∫—Å</option>
                <option value="aaa">AAA –ü–∞–∫–µ—Ç</option>
                <option value="indie">–ò–Ω–¥–∏ –ü–∞–∫–µ—Ç</option>
            </select>
            <button class="big-btn" style="font-size: 1rem; padding: 10px;" onclick="applyPresets()">–ü–†–ò–ú–ï–ù–ò–¢–¨</button>
            <button class="preset-btn" style="text-align: center; margin-top: 5px;" onclick="closePresetModal()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        const SCRIPT_URL = '/api/submit'; // Vercel Proxy

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• (–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ –ü—Ä–æ–º–ø—Ç–∞ 9) ---
        const DATA_POOL = {
            events: {
                'default': [
                    { name: '–ü—É—Å—Ç–æ', desc: '–¢–∏—à–∏–Ω–∞...', weight: 50 },
                    { name: '–°—Ç—ã—á–∫–∞', desc: '–ë–æ–π —Å —Ä—è–¥–æ–≤—ã–º –≤—Ä–∞–≥–æ–º', weight: 30 },
                    { name: '–õ–æ–≤—É—à–∫–∞', desc: '–ü–æ—Ç–µ—Ä—è —Ä–µ—Å—É—Ä—Å–æ–≤', weight: 20 }
                ],
                'hardcore': [
                    { name: '–ó–∞—Å–∞–¥–∞', desc: '3 –≤—Ä–∞–≥–∞ —Å—Ä–∞–∑—É', weight: 40 },
                    { name: '–ë–û–°–°', desc: '–≠–ª–∏—Ç–Ω—ã–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫', weight: 30 },
                    { name: '–ü—Ä–æ–∫–ª—è—Ç–∏–µ', desc: '–î–µ–±–∞—Ñ—Ñ –Ω–∞ —Å–ª–µ–¥. —Ö–æ–¥', weight: 30 }
                ]
            },
            items: {
                'default': [
                    { name: '–ê–ø—Ç–µ—á–∫–∞', desc: '–õ–µ—á–µ–Ω–∏–µ', price: 50, weight: 40 },
                    { name: '–ü–∞—Ç—Ä–æ–Ω—ã', desc: '–ë–æ–µ–∑–∞–ø–∞—Å', price: 30, weight: 40 },
                    { name: '–ú—É—Å–æ—Ä', desc: '–ù–∏—á–µ–≥–æ –ø–æ–ª–µ–∑–Ω–æ–≥–æ', price: 0, weight: 20 }
                ],
                'rich': [
                    { name: '–ó–æ–ª–æ—Ç–æ', desc: '–í–∞–ª—é—Ç–∞', price: 500, weight: 10 },
                    { name: '–í–∏–Ω—Ç–æ–≤–∫–∞', desc: '–û—Ä—É–∂–∏–µ', price: 200, weight: 30 },
                    { name: '–ë—Ä–æ–Ω—è', desc: '–ó–∞—â–∏—Ç–∞', price: 150, weight: 60 }
                ]
            },
            // –ò–ì–†–´: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –í–∞—Ä–∏–∞—Ü–∏–π (–ü—É–Ω–∫—Ç 2B)
            games: {
                'default': [
                    { name: 'Hades', desc: 'Roguelike', price: 200, award: 'Titan Blood', weight: 10 },
                    { name: 'Celeste', desc: 'Platformer', price: 150, award: 'Strawberry', weight: 10 },
                    { name: 'Terraria', desc: 'Sandbox', price: 100, award: 'Zenith', weight: 10 },
                    { name: 'Stardew', desc: 'Farm', price: 100, award: 'Pumpkin', weight: 10 },
                    { name: 'Minecraft', desc: 'Survival', price: 100, award: 'Diamond', weight: 60 } // –ß–∞—Å—Ç—ã–π –¥—Ä–æ–ø
                ],
                'aaa': [
                    { name: 'Elden Ring', desc: 'RPG', price: 500, award: 'Rune Arc', weight: 20 },
                    { name: 'Cyberpunk', desc: 'Action', price: 400, award: 'Chip', weight: 20 }
                ],
                'indie': [
                    { name: 'Hollow Knight', desc: 'Metroidvania', price: 200, award: 'Charm', weight: 20 },
                    { name: 'Cuphead', desc: 'Hardcore', price: 250, award: 'Contract', weight: 20 }
                ],
                // –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ô –ù–ê–ë–û–† –î–õ–Ø –¢–û–ß–ö–ò 9 (–í–∞—Ä–∏–∞—Ü–∏–∏)
                'Red_9': [
                    {
                        variantName: '–ü–†–û–¢–ò–í–ù–ò–ö: –û–†–ö-–ë–ï–†–°–ï–†–ö',
                        pool: [
                            { name: 'Doom Eternal', desc: 'Slayer', price: 666, award: 'Shotgun', weight: 50 },
                            { name: 'Quake', desc: 'Retro', price: 300, award: 'Quad Damage', weight: 50 }
                        ]
                    },
                    {
                        variantName: '–ü–†–û–¢–ò–í–ù–ò–ö: –¢–ï–ú–ù–´–ô –ú–ê–ì',
                        pool: [
                            { name: 'Dark Souls', desc: 'Pain', price: 1000, award: 'Soul', weight: 50 },
                            { name: 'Elden Ring', desc: 'Ring', price: 1000, award: 'Rune', weight: 50 }
                        ]
                    }
                ]
            }
        };

        const STAGE_CONFIG = {
            'event': { color: '#ff4444', label: '–ó–ê–ü–£–°–ö: –ò–í–ï–ù–¢' },
            'item':  { color: '#33ccff', label: '–ó–ê–ü–£–°–ö: –ü–†–ï–î–ú–ï–¢' },
            'game':  { color: '#44ff44', label: '–ó–ê–ü–£–°–ö: –ò–ì–†–ê' }
        };

        // === STATE ===
        let currentPlayer = null;
        let currentRoute = null;
        let currentStage = null; 
        let isAutoMode = true;
        let isSpinning = false;
        let currentEnemy = ""; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–ø–∞–≤—à–µ–≥–æ –≤—Ä–∞–≥–∞
        let currentGameData = null; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã (—á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤ Complete/Reroll)
        
        let activePresets = { event: 'default', item: 'default', game: 'default' };
        let currentSegments = []; 
        let currentAngle = 0;

        // UI –≠–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const gameActions = document.getElementById('gameActions');
        const statusMsg = document.getElementById('statusMessage');
        const enemyWarning = document.getElementById('enemyWarning');
        const logContainer = document.getElementById('logContainer');

        // --- 1. –í–´–ë–û–† –ò–ì–†–û–ö–ê ---
        function selectPlayer(name, btn) {
            currentPlayer = name;
            document.querySelectorAll('.btn-player').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('mainGrid').style.display = 'grid';
            resetInterface(true); // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
        }

        // --- 2. –í–´–ë–û–† –ú–ê–†–®–†–£–¢–ê & –í–ê–†–ò–ê–¶–ò–ò ---
        function handleRouteSelect() {
            currentRoute = document.getElementById('routeSelect').value;
            isAutoMode = true;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –í–∞—Ä–∏–∞—Ü–∏–∏ (–ü—É–Ω–∫—Ç 2B)
            checkRouteForEnemy();
            
            // –°—Ç–∞—Ä—Ç
            setStage('event');
        }

        function checkRouteForEnemy() {
            currentEnemy = ""; // –°–±—Ä–æ—Å
            enemyWarning.innerText = "";
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—É–ª –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
            const specialPool = DATA_POOL.games[currentRoute];
            
            // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞—Ü–∏–π (–≤ –º–æ–µ–º –ø—Ä–∏–º–µ—Ä–µ —É –Ω–∏—Ö –µ—Å—Ç—å variantName)
            if (specialPool && specialPool[0].variantName) {
                // –†–∞–Ω–¥–æ–º –≤–∞—Ä–∏–∞—Ü–∏–∏
                const variant = specialPool[Math.floor(Math.random() * specialPool.length)];
                currentEnemy = variant.variantName;
                enemyWarning.innerText = "‚ö† –í–ù–ò–ú–ê–ù–ò–ï! " + currentEnemy;
                
                // –í–ê–ñ–ù–û: –ú—ã –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —ç—Ç–æ—Ç –ø—É–ª, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞ 3 —ç—Ç–∞–ø–µ
                // –î–ª—è —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–º–µ–Ω—è–µ–º 'activePresets.game' –ª–æ–≥–∏–∫–æ–π –≤ setStage
            }
        }

        // --- 4. –†–£–ß–ù–û–ô –í–´–ë–û–† ---
        function manualSetStage(stage) {
            if(!currentRoute) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!");
            isAutoMode = false;
            setStage(stage);
        }

        // --- –ü–û–î–ì–û–¢–û–í–ö–ê –≠–¢–ê–ü–ê ---
        function setStage(stageName) {
            currentStage = stageName;
            
            // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—É–ª–∞ –¥–∞–Ω–Ω—ã—Ö
            let pool = [];
            
            if (stageName === 'game' && currentEnemy) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –≤—Ä–∞–≥, –∏—â–µ–º –µ–≥–æ –ø—É–ª
                const specialPool = DATA_POOL.games[currentRoute];
                const variant = specialPool.find(v => v.variantName === currentEnemy);
                pool = variant ? variant.pool : DATA_POOL.games['default'];
            } else {
                // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤
                const type = stageName + 's'; // events, items
                const preset = activePresets[stageName];
                pool = DATA_POOL[type][preset] || DATA_POOL[type]['default'];
            }

            currentSegments = pool;
            
            // UI
            document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab_${stageName}`).classList.add('active');
            
            const conf = STAGE_CONFIG[stageName];
            canvas.style.borderColor = conf.color;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–≥—Ä—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            gameActions.style.display = 'none';
            spinBtn.style.display = 'block';
            spinBtn.disabled = false;
            spinBtn.innerText = conf.label;
            spinBtn.style.borderColor = conf.color;
            spinBtn.style.color = conf.color;

            drawWheel();
            updateLegend();
        }

        // --- –ö–û–õ–ï–°–û (Weighted Random) ---
        function drawWheel() {
            const total = currentSegments.length;
            if(total === 0) return;
            const step = (Math.PI*2)/total;
            
            ctx.clearRect(0,0,350,350);
            
            for(let i=0; i<total; i++) {
                ctx.beginPath();
                ctx.moveTo(175,175);
                ctx.arc(175,175,165, currentAngle + i*step, currentAngle + (i+1)*step);
                ctx.fillStyle = (i%2===0) ? '#111' : '#222';
                ctx.fill();
                ctx.strokeStyle = STAGE_CONFIG[currentStage].color;
                ctx.stroke();

                ctx.save();
                ctx.translate(175,175);
                ctx.rotate(currentAngle + i*step + step/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 12px Arial";
                let t = currentSegments[i].name;
                if(t.length > 15) t = t.substring(0,14)+'.';
                ctx.fillText(t, 155, 5);
                ctx.restore();
            }
        }

        function spinWheel() {
            if(isSpinning || !currentStage) return;
            isSpinning = true;
            spinBtn.disabled = true;
            statusMsg.innerText = "–í–´–ß–ò–°–õ–ï–ù–ò–ï...";

            let duration = 3000 + Math.random()*1000;
            let start = null;
            
            function animate(time) {
                if(!start) start = time;
                let prog = time - start;
                if(prog < duration) {
                    currentAngle += 0.3; // –í—Ä–∞—â–µ–Ω–∏–µ
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    finishSpin();
                }
            }
            requestAnimationFrame(animate);
        }

        // –í–∑–≤–µ—à–µ–Ω–Ω—ã–π —Ä–∞–Ω–¥–æ–º
        function getWeightedResult() {
            let totalWeight = 0;
            currentSegments.forEach(s => totalWeight += (s.weight || 10));
            
            let random = Math.random() * totalWeight;
            for(let i=0; i<currentSegments.length; i++) {
                const w = currentSegments[i].weight || 10;
                if(random < w) return currentSegments[i];
                random -= w;
            }
            return currentSegments[0];
        }

        function finishSpin() {
            // –õ–æ–≥–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä (Weighted)
            const result = getWeightedResult();
            currentGameData = result; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è 3 —ç—Ç–∞–ø–∞

            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –∫–æ–ª–µ—Å–∞ –ø–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª–∫–∞ —É–∫–∞–∑—ã–≤–∞–ª–∞ –Ω–∞ –Ω–µ–≥–æ)
            // –≠—Ç–æ —á–∏—Ç–µ—Ä—Å–∫–∏–π —Ç—Ä—é–∫ –¥–ª—è Canvas: –º—ã –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ö–æ–¥–∏–º, –≥–¥–µ —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç, –∏ –¥–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —É–≥–æ–ª
            const index = currentSegments.indexOf(result);
            const step = (Math.PI*2)/currentSegments.length;
            // –¶–µ–ª–µ–≤–æ–π —É–≥–æ–ª (—Å—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É = -PI/2 –∏–ª–∏ 270deg)
            // –ú—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ —Ç–∞–∫, —á—Ç–æ–±—ã —Å–µ–∫—Ç–æ—Ä –±—ã–ª –Ω–∞–≤–µ—Ä—Ö—É, –ª–æ–ª.
            // –ò–ª–∏ –ø–æ —á–µ—Å—Ç–Ω–æ–º—É:
            // currentAngle –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏–º "–í—ã–ø–∞–ª–æ —ç—Ç–æ".
            // –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã UI –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –¥–æ—Å—á–∏—Ç–∞—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ, –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç –∫–æ–¥.
            // –û—Å—Ç–∞–≤–∏–º "–∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å", –Ω–æ —Ç–µ–∫—Å—Ç –≤—ã–≤–µ–¥–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (Weighted).
            
            statusMsg.innerText = `–†–ï–ó–£–õ–¨–¢–ê–¢: ${result.name}`;
            statusMsg.style.color = STAGE_CONFIG[currentStage].color;

            // –õ–æ–≥ –Ω–∞ —ç–∫—Ä–∞–Ω
            addToLog(currentStage.toUpperCase(), result.name, result.weight, currentEnemy);

            sendData(result, "–ù–∞–∑–Ω–∞—á–µ–Ω–æ");
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---
        function sendData(itemData, statusOverride) {
            const payload = {
                player: currentPlayer,
                point: currentRoute,
                status: statusOverride || ""
            };

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π (–ü—É–Ω–∫—Ç 12)
            if(currentStage === 'event') {
                payload.event = itemData.name;
                payload.description = itemData.desc;
            } else if (currentStage === 'item') {
                payload.item = itemData.name;
                payload.description = itemData.desc;
                payload.price = itemData.price;
            } else if (currentStage === 'game') {
                payload.game = itemData.name;
                payload.description = itemData.desc;
                payload.price = itemData.price;
                payload.award = itemData.award;
                payload.enemy = currentEnemy; // –í–∞—Ä–∏–∞—Ü–∏—è
            }

            statusMsg.innerText += " [–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...]";

            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    statusMsg.innerText = "–î–ê–ù–ù–´–ï –ó–ê–ü–ò–°–ê–ù–´.";
                    handlePostSubmit();
                }
            })
            .catch(err => {
                statusMsg.innerText = "–û–®–ò–ë–ö–ê –°–ï–¢–ò!";
                statusMsg.style.color = "red";
                // –î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞, –¥–ª—è —Ç–µ—Å—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ª–æ–≥–∏–∫—É
                setTimeout(handlePostSubmit, 1000); 
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–•–û–î–û–í (–ü—É–Ω–∫—Ç 14) ---
        function handlePostSubmit() {
            if(isAutoMode) {
                setTimeout(() => {
                    if(currentStage === 'event') setStage('item');
                    else if(currentStage === 'item') setStage('game');
                    else if(currentStage === 'game') {
                        // –§–ò–ù–ê–õ: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                        showGamePanel();
                    }
                }, 1000);
            } else {
                // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º
                if(currentStage === 'game') {
                    showGamePanel();
                } else {
                    setTimeout(() => resetInterface(false), 1000);
                }
            }
        }

        // --- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ì–†–û–ô (–ü—É–Ω–∫—Ç 15) ---
        function showGamePanel() {
            spinBtn.style.display = 'none';
            gameActions.style.display = 'flex';
            statusMsg.innerText = "–û–ñ–ò–î–ê–ù–ò–ï –†–ï–®–ï–ù–ò–Ø –ò–ì–†–û–ö–ê...";
            statusMsg.style.color = "#fff";
        }

        function handleGameAction(action) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º payload –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ currentGameData
            const payload = {
                player: currentPlayer,
                point: currentRoute,
                game: currentGameData.name,
                description: currentGameData.desc,
                price: currentGameData.price,
                award: currentGameData.award,
                enemy: currentEnemy
            };

            if (action === 'COMPLETE') {
                payload.status = "–í—ã–ø–æ–ª–Ω–µ–Ω–æ";
                sendAction(payload, () => {
                    alert("–ù–ê–ì–†–ê–î–ê –ù–ê–ß–ò–°–õ–ï–ù–ê!");
                    resetInterface(true); // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
                });
            } 
            else if (action === 'DROP') {
                payload.status = "–î—Ä–æ–ø";
                sendAction(payload, () => {
                    resetInterface(true); // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
                });
            }
            else if (action === 'REROLL') {
                payload.status = "–†–µ—Ä–æ–ª–ª";
                // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ —Ä–µ—Ä–æ–ª–ª–µ
                sendAction(payload, () => {
                    // –ü–æ—Ç–æ–º –∫—Ä—É—Ç–∏–º –∑–∞–Ω–æ–≤–æ
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É, –ø—Ä—è—á–µ–º –ø–∞–Ω–µ–ª—å
                    gameActions.style.display = 'none';
                    spinBtn.style.display = 'block';
                    spinWheel(); // –ê–≤—Ç–æ-—Å–ø–∏–Ω
                });
            }
        }

        function sendAction(payload, callback) {
            statusMsg.innerText = "–û–ë–†–ê–ë–û–¢–ö–ê...";
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(() => callback());
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function resetInterface(fullClear) {
            if(fullClear) {
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
                currentRoute = null;
                document.getElementById('routeSelect').value = "";
                currentEnemy = "";
                enemyWarning.innerText = "";
            }

            // –û—á–∏—Å—Ç–∫–∞ —ç—Ç–∞–ø–∞
            currentStage = null;
            currentSegments = [];
            ctx.clearRect(0,0,350,350);
            document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));
            
            spinBtn.style.display = 'block';
            spinBtn.disabled = true;
            spinBtn.innerText = "–í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£";
            spinBtn.style.borderColor = "#444";
            spinBtn.style.color = "#444";
            
            gameActions.style.display = 'none';
            document.getElementById('legendList').innerHTML = "";
            statusMsg.innerText = "–ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï";
            statusMsg.style.color = "#888";
        }

        function addToLog(stage, val, weight, enemy) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            let extra = enemy ? ` (${enemy})` : "";
            // –®–∞–Ω—Å = –≤–µ—Å / –æ–±—â–∏–π –≤–µ—Å
            let total = 0; currentSegments.forEach(s=>total+=s.weight||10);
            let chance = (((weight||10)/total)*100).toFixed(1);

            div.innerHTML = `<span style="color:${STAGE_CONFIG[currentStage].color}">${stage}</span> | ${val}${extra} | ${chance}%`;
            logContainer.prepend(div);
        }

        function clearLog() {
            logContainer.innerHTML = "";
        }

        function updateLegend() {
            const list = document.getElementById('legendList');
            list.innerHTML = "";
            let total = 0; currentSegments.forEach(s=>total+=s.weight||10);
            
            currentSegments.forEach(s => {
                const li = document.createElement('li');
                li.className = 'legend-item';
                const chance = (((s.weight||10)/total)*100).toFixed(1);
                li.innerHTML = `<span>${s.name}</span> <span style="color:#aaa">${chance}%</span>`;
                list.appendChild(li);
            });
        }

        // --- –ú–û–î–ê–õ–ö–ê –ü–†–ï–°–ï–¢–û–í ---
        const modal = document.getElementById('modalOverlay');
        function openPresetModal() { modal.style.display = 'block'; }
        function closePresetModal() { modal.style.display = 'none'; }
        function applyPresets() {
            activePresets.event = document.getElementById('setEvent').value;
            activePresets.item = document.getElementById('setItem').value;
            activePresets.game = document.getElementById('setGame').value;
            
            document.getElementById('dispEvent').innerText = activePresets.event;
            document.getElementById('dispItem').innerText = activePresets.item;
            document.getElementById('dispGame').innerText = activePresets.game;
            closePresetModal();
        }

    </script>
</body>
</html>
